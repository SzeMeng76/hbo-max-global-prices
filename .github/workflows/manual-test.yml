name: Manual HBO Max Test

on:
  workflow_dispatch:
    inputs:
      test_countries:
        description: 'æµ‹è¯•çš„å›½å®¶ä»£ç  (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: us,sg,my)'
        required: false
        default: 'us,sg,my'
      max_concurrent:
        description: 'æœ€å¤§å¹¶å‘æ•°'
        required: false
        default: '3'

permissions:
  contents: write
  actions: read

env:
  TZ: Asia/Shanghai

jobs:
  test-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create test script
      run: |
        cat > test_max.py << 'EOF'
        import asyncio
        import os
        import json
        from max_scraper import get_max_prices_for_country, COUNTRY_NAMES
        
        async def test_countries():
            test_countries = os.getenv('TEST_COUNTRIES', 'us,sg,my').split(',')
            max_concurrent = int(os.getenv('MAX_CONCURRENT', '3'))
            
            print(f"ðŸ§ª æµ‹è¯•å›½å®¶: {test_countries}")
            print(f"ðŸ“Š æœ€å¤§å¹¶å‘æ•°: {max_concurrent}")
            
            semaphore = asyncio.Semaphore(max_concurrent)
            results = {}
            
            async def test_country(country_code):
                async with semaphore:
                    print(f"\nðŸ” æµ‹è¯• {country_code.upper()}...")
                    result = await get_max_prices_for_country(country_code.strip(), max_retries=1)
                    return country_code.strip().upper(), result
            
            tasks = [test_country(cc) for cc in test_countries]
            test_results = await asyncio.gather(*tasks, return_exceptions=True)
            
            success_count = 0
            for result in test_results:
                if isinstance(result, Exception):
                    print(f"âŒ æµ‹è¯•å¼‚å¸¸: {result}")
                elif isinstance(result, tuple):
                    country_code, data = result
                    if data:
                        results[country_code] = data
                        success_count += 1
                        print(f"âœ… {country_code}: æˆåŠŸèŽ·å– {len(data.get('plans', []))} ä¸ªå¥—é¤")
                    else:
                        print(f"âŒ {country_code}: æœªèŽ·å–åˆ°æ•°æ®")
            
            print(f"\nðŸ“Š æµ‹è¯•ç»“æžœ: {success_count}/{len(test_countries)} æˆåŠŸ")
            return results
        
        if __name__ == '__main__':
            results = asyncio.run(test_countries())
            
            if results:
                with open('test_results.json', 'w', encoding='utf-8') as f:
                    json.dump(results, f, ensure_ascii=False, indent=2)
                print("ðŸ“ æµ‹è¯•ç»“æžœå·²ä¿å­˜åˆ° test_results.json")
                
                # æ˜¾ç¤ºè¯¦ç»†ç»“æžœ
                for country, data in results.items():
                    print(f"\nðŸŒ {country} ({data.get('country_name', 'Unknown')}):")
                    for plan in data.get('plans', []):
                        print(f"  ðŸ“¦ {plan.get('name', 'Unknown')}: {plan.get('price', 'N/A')}")
            else:
                print("âŒ æ²¡æœ‰æˆåŠŸçš„æµ‹è¯•ç»“æžœ")
        EOF
        
    - name: Test HBO Max scraper
      env:
        PROXY_API_TEMPLATE: ${{ secrets.PROXY_API_TEMPLATE }}
        TEST_COUNTRIES: ${{ github.event.inputs.test_countries || 'us,sg,my' }}
        MAX_CONCURRENT: ${{ github.event.inputs.max_concurrent || '3' }}
      run: |
        echo "å¼€å§‹æµ‹è¯• HBO Max æŠ“å–..."
        echo "æµ‹è¯•å›½å®¶: $TEST_COUNTRIES"
        echo "æœ€å¤§å¹¶å‘: $MAX_CONCURRENT"
        python test_max.py
        
    - name: Test rate converter
      if: hashFiles('test_results.json') != ''
      env:
        API_KEY: ${{ secrets.EXCHANGE_API_KEY }}
      run: |
        echo "æµ‹è¯•æ±‡çŽ‡è½¬æ¢..."
        # å°†æµ‹è¯•ç»“æžœé‡å‘½åä¸ºæ ‡å‡†è¾“å…¥æ–‡ä»¶
        cp test_results.json max_prices_all_countries.json
        # è¿è¡Œæ±‡çŽ‡è½¬æ¢
        python max_rate_converter.py
        
    - name: Show test results
      if: always()
      run: |
        echo "=== æµ‹è¯•ç»“æžœæ‘˜è¦ ==="
        
        if [ -f "test_results.json" ]; then
          echo "âœ… æŠ“å–æµ‹è¯•: æˆåŠŸ"
          echo "ðŸ“Š æµ‹è¯•æ•°æ®:"
          echo "æ–‡ä»¶å¤§å°: $(du -h test_results.json | cut -f1)"
        else
          echo "âŒ æŠ“å–æµ‹è¯•: å¤±è´¥"
        fi
        
        if [ -f "max_prices_cny_sorted.json" ]; then
          echo "âœ… æ±‡çŽ‡è½¬æ¢: æˆåŠŸ"
          echo "æ–‡ä»¶å¤§å°: $(du -h max_prices_cny_sorted.json | cut -f1)"
        else
          echo "âŒ æ±‡çŽ‡è½¬æ¢: å¤±è´¥"
        fi
        
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          test_results.json
          max_prices_cny_sorted.json
        retention-days: 7