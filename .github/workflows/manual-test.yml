name: Manual HBO Max Test

on:
  workflow_dispatch:
    inputs:
      test_countries:
        description: 'æµ‹è¯•çš„å›½å®¶ä»£ç  (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: us,sg,my)'
        required: false
        default: 'us,sg,my'
      max_concurrent:
        description: 'æœ€å¤§å¹¶å‘æ•°'
        required: false
        default: '3'

permissions:
  contents: write
  actions: read

env:
  TZ: Asia/Shanghai

jobs:
  test-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Test HBO Max scraper
      env:
        PROXY_API_TEMPLATE: ${{ secrets.PROXY_API_TEMPLATE }}
        TEST_COUNTRIES: ${{ github.event.inputs.test_countries || 'us,sg,my' }}
        MAX_CONCURRENT: ${{ github.event.inputs.max_concurrent || '3' }}
      run: |
        echo "å¼€å§‹æµ‹è¯• HBO Max æŠ“å–..."
        echo "æµ‹è¯•å›½å®¶: $TEST_COUNTRIES"
        echo "æœ€å¤§å¹¶å‘: $MAX_CONCURRENT"
        
        # åˆ›å»ºç®€åŒ–çš„æµ‹è¯•è„šæœ¬
        cat > test_scraper.py << 'EOF'
import asyncio
import os
from max_scraper import get_max_prices_for_country, COUNTRY_NAMES

async def test_countries():
    test_countries = os.getenv('TEST_COUNTRIES', 'us,sg,my').split(',')
    max_concurrent = int(os.getenv('MAX_CONCURRENT', '3'))
    
    print(f"ğŸ§ª æµ‹è¯•å›½å®¶: {test_countries}")
    print(f"ğŸ“Š æœ€å¤§å¹¶å‘æ•°: {max_concurrent}")
    
    semaphore = asyncio.Semaphore(max_concurrent)
    results = {}
    
    async def test_country(country_code):
        async with semaphore:
            print(f"\nğŸ” æµ‹è¯• {country_code.upper()}...")
            result = await get_max_prices_for_country(country_code.strip(), max_retries=1)
            return country_code.strip().upper(), result
    
    tasks = [test_country(cc) for cc in test_countries]
    test_results = await asyncio.gather(*tasks, return_exceptions=True)
    
    success_count = 0
    for result in test_results:
        if isinstance(result, Exception):
            print(f"âŒ æµ‹è¯•å¼‚å¸¸: {result}")
        elif isinstance(result, tuple):
            country_code, data = result
            if data:
                results[country_code] = data
                success_count += 1
                print(f"âœ… {country_code}: æˆåŠŸè·å– {len(data.get('plans', []))} ä¸ªå¥—é¤")
            else:
                print(f"âŒ {country_code}: æœªè·å–åˆ°æ•°æ®")
    
    print(f"\nğŸ“Š æµ‹è¯•ç»“æœ: {success_count}/{len(test_countries)} æˆåŠŸ")
    return results

if __name__ == '__main__':
    results = asyncio.run(test_countries())
    
    if results:
        import json
        with open('test_results.json', 'w', encoding='utf-8') as f:
            json.dump(results, f, ensure_ascii=False, indent=2)
        print("ğŸ“ æµ‹è¯•ç»“æœå·²ä¿å­˜åˆ° test_results.json")
        
        # æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        for country, data in results.items():
            print(f"\nğŸŒ {country} ({data.get('country_name', 'Unknown')}):")
            for plan in data.get('plans', []):
                print(f"  ğŸ“¦ {plan.get('name', 'Unknown')}: {plan.get('price', 'N/A')}")
    else:
        print("âŒ æ²¡æœ‰æˆåŠŸçš„æµ‹è¯•ç»“æœ")
EOF
        
        python test_scraper.py
        
    - name: Test rate converter
      if: hashFiles('test_results.json') != ''
      env:
        API_KEY: ${{ secrets.EXCHANGE_API_KEY }}
      run: |
        echo "æµ‹è¯•æ±‡ç‡è½¬æ¢..."
        
        # å°†æµ‹è¯•ç»“æœé‡å‘½åä¸ºæ ‡å‡†è¾“å…¥æ–‡ä»¶
        cp test_results.json max_prices_all_countries.json
        
        # è¿è¡Œæ±‡ç‡è½¬æ¢
        python max_rate_converter.py
        
    - name: Show test results
      if: always()
      run: |
        echo "=== æµ‹è¯•ç»“æœæ‘˜è¦ ==="
        
        if [ -f "test_results.json" ]; then
          echo "âœ… æŠ“å–æµ‹è¯•: æˆåŠŸ"
          echo "ğŸ“Š æµ‹è¯•æ•°æ®:"
          python -c "
import json
with open('test_results.json', 'r') as f:
    data = json.load(f)
for country, info in data.items():
    plans = info.get('plans', [])
    print(f'  {country}: {len(plans)} ä¸ªå¥—é¤')
"
        else
          echo "âŒ æŠ“å–æµ‹è¯•: å¤±è´¥"
        fi
        
        if [ -f "max_prices_cny_sorted.json" ]; then
          echo "âœ… æ±‡ç‡è½¬æ¢: æˆåŠŸ"
          echo "ğŸ† æœ€ä¾¿å®œçš„å¥—é¤:"
          python -c "
import json
try:
    with open('max_prices_cny_sorted.json', 'r') as f:
        data = json.load(f)
    top_plans = data.get('_top_10_cheapest_all', {}).get('data', [])
    for plan in top_plans[:3]:
        country = plan.get('country_name_cn', plan.get('country_name', 'Unknown'))
        name = plan.get('plan_name', 'Unknown')
        price = plan.get('price_cny', 0)
        print(f'  {country} - {name}: Â¥{price}')
except:
    print('  è§£æå¤±è´¥')
"
        else
          echo "âŒ æ±‡ç‡è½¬æ¢: å¤±è´¥"
        fi
        
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          test_results.json
          max_prices_cny_sorted.json
        retention-days: 7